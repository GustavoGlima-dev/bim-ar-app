<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Visualizador GLTF/GLB com WebXR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; }
    .container {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      text-align: center;
    }
    .upload-button {
      background-color: #2563eb;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    .status-message { margin-top: 10px; font-size: 1rem; color: #0891b2; }
  </style>
</head>
<body>
  <div class="container" id="ui">
    <h1>Visualizador GLTF/GLB em AR</h1>
    <p>Selecione um arquivo .GLTF ou .GLB e depois toque no chão/mesa para posicionar.</p>
    <label for="fileInput" class="upload-button">Selecionar Arquivo</label>
    <input type="file" id="fileInput" accept=".gltf,.glb" style="display:none">
    <div class="status-message" id="status"></div>
  </div>

  <a-scene
    webxr="optionalFeatures: hit-test;"
    xrweb="optionalFeatures: hit-test;"
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true;"
  >
    <!-- Luzes -->
    <a-entity light="type: hemisphere; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>

    <!-- Container do modelo (invisível até upload + toque) -->
    <a-entity id="model" visible="false"></a-entity>

    <!-- Câmera -->
    <a-camera position="0 1.6 0"></a-camera>
  </a-scene>

  <script>
    const fileInput = document.getElementById("fileInput");
    const statusDiv = document.getElementById("status");
    const model = document.getElementById("model");
    const scene = document.querySelector("a-scene");

    let modelUrl = null; // guarda o URL do arquivo carregado

    function showStatus(msg) {
      statusDiv.innerText = msg;
    }

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      showStatus("Carregando modelo...");

      try {
        if (modelUrl) URL.revokeObjectURL(modelUrl); // libera URL antiga
        modelUrl = URL.createObjectURL(file);

        // limpa atributos antigos
        model.removeAttribute("gltf-model");

        // aplica o novo modelo
        model.setAttribute("gltf-model", modelUrl);
        model.setAttribute("scale", "0.05 0.05 0.05");
        model.setAttribute("visible", "false");

        model.addEventListener("model-loaded", () => {
          showStatus("Modelo carregado! Toque em uma superfície para posicionar.");
        });

        model.addEventListener("error", (err) => {
          console.error("Erro no modelo:", err);
          showStatus("Erro: não foi possível carregar este arquivo.");
        });

      } catch (err) {
        console.error(err);
        showStatus("Falha ao processar o arquivo.");
      }
    });

    // posiciona o modelo no ponto tocado
    scene.addEventListener("click", (ev) => {
      if (!modelUrl) {
        showStatus("Selecione um arquivo primeiro.");
        return;
      }
      if (ev.detail.intersection) {
        const { x, y, z } = ev.detail.intersection.point;
        model.setAttribute("position", `${x} ${y} ${z}`);
        model.setAttribute("visible", "true");
        showStatus("Modelo posicionado.");
      }
    });
  </script>
</body>
</html>
