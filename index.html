<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador BIM em AR</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js genérico (abre a câmera sempre) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- Gestos -->
  <script src="https://unpkg.com/aframe-gesture-detector/dist/aframe-gesture-detector.min.js"></script>
  <script src="https://unpkg.com/aframe-gesture-handler/dist/aframe-gesture-handler.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
    .container {
      position: absolute; top: 0; left: 0; right: 0;
      z-index: 9999; background: rgba(255,255,255,0.95);
      padding: 20px; text-align: center;
    }
    h1 { font-size: 1.4rem; margin: 0 0 10px; }
    .upload-button {
      background-color: #2563eb; color: white;
      padding: 10px 20px; border: none; border-radius: 6px;
      cursor: pointer; font-size: 1rem; font-weight: 600;
    }
    .status-message { margin-top: 10px; font-size: 1rem; color: #0891b2; }
  </style>
</head>
<body>
  <div class="container" id="app-container">
    <h1>Visualizador BIM em AR</h1>
    <p>Selecione um arquivo .GLTF ou .GLB para visualizar em realidade aumentada.</p>
    <label for="fileInput" class="upload-button">Selecionar Arquivo</label>
    <input type="file" id="fileInput" accept=".gltf,.glb" style="display:none;">
    <div class="status-message" id="status"></div>
  </div>

  <a-scene 
    id="ar-scene" 
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    gesture-detector
  >
    <a-entity id="model-container"></a-entity>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('fileInput');
      const statusDiv = document.getElementById('status');
      const arScene = document.getElementById('ar-scene');
      const appContainer = document.getElementById('app-container');
      const modelContainer = document.getElementById('model-container');
      let modelUrl = null;

      function showStatus(message) { statusDiv.innerText = message; }

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processando arquivo...');
        try {
          modelUrl = URL.createObjectURL(file);
          while (modelContainer.firstChild) modelContainer.removeChild(modelContainer.firstChild);

          const model = document.createElement('a-entity');
          model.setAttribute('gltf-model', modelUrl);
          model.setAttribute('scale', '0.05 0.05 0.05');
          model.setAttribute('position', '0 0 -3'); // aparece 3m à frente sempre
          model.setAttribute('animation-mixer', '');

          // tenta aplicar GPS
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              model.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);
              showStatus(`Modelo reposicionado no GPS (lat:${lat.toFixed(5)}, lon:${lon.toFixed(5)}).`);
            }, err => {
              showStatus("Erro GPS, mantendo posição fixa. " + err.message);
            });
          }

          // gestos
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            model.setAttribute('ios-gestures', 'factor: 0.003; zoomFactor: 0.005');
          } else {
            model.setAttribute('gesture-handler', 'minScale: 0.01; maxScale: 2');
          }

          model.addEventListener('model-loaded', () => {
            appContainer.style.display = 'none';
            arScene.style.display = 'block';
            showStatus('Modelo carregado! Interaja com gestos ou mouse.');
          });

          modelContainer.appendChild(model);
        } catch (error) {
          console.error('Erro ao processar o arquivo:', error);
          showStatus('Falha ao carregar o modelo.');
        }
      });
    });
  </script>
</body>
</html>
