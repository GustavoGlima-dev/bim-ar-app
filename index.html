<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador BIM em AR - Tap to Place</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }
    .container {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      padding: 20px;
      text-align: center;
    }
    h1 { font-size: 1.2rem; margin: 0 0 10px; }
    .upload-button, .reset-button {
      background-color: #2563eb;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin: 5px;
    }
    .status-message { margin-top: 10px; font-size: 0.9rem; color: #0891b2; }
  </style>
</head>
<body>
  <div class="container" id="app-container">
    <h1>Visualizador BIM em AR</h1>
    <p>Selecione um arquivo .GLTF ou .GLB.</p>
    <label for="fileInput" class="upload-button">Selecionar Arquivo</label>
    <input type="file" id="fileInput" accept=".gltf,.glb" style="display:none;">
    <button id="resetBtn" class="reset-button" style="display:none;">Resetar Modelo</button>
    <div class="status-message" id="status"></div>
  </div>

  <a-scene
    id="ar-scene"
    vr-mode-ui="enabled: false"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-entity camera></a-entity>
    <a-entity id="placed-model"></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector('#ar-scene');
    const modelEntity = document.querySelector('#placed-model');
    const fileInput = document.querySelector('#fileInput');
    const statusDiv = document.querySelector('#status');
    const resetBtn = document.querySelector('#resetBtn');
    let modelUrl = null;
    let modelLoaded = false;

    function showStatus(msg) { statusDiv.innerText = msg; }

    // Upload do modelo
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      showStatus("Carregando modelo...");
      try {
        modelUrl = URL.createObjectURL(file);

        modelEntity.setAttribute('gltf-model', modelUrl);
        modelEntity.setAttribute('scale', '0.05 0.05 0.05');
        modelEntity.setAttribute('visible', 'false'); // só aparece depois do tap

        modelEntity.addEventListener('model-loaded', () => {
          modelLoaded = true;
          showStatus("Modelo pronto! Toque na tela para posicionar.");
          resetBtn.style.display = "inline-block";
        });

        modelEntity.addEventListener('model-error', (err) => {
          console.error("Erro ao carregar modelo:", err);
          showStatus("Erro ao carregar modelo.");
        });
      } catch (e) {
        console.error(e);
        showStatus("Falha ao processar o arquivo.");
      }
    });

    // Tap-to-place: ancora modelo
    scene.addEventListener('click', () => {
      if (!modelLoaded) return;

      const camera = scene.camera.el.object3D;
      const camPos = new THREE.Vector3();
      const camDir = new THREE.Vector3();
      camera.getWorldPosition(camPos);
      camera.getWorldDirection(camDir);

      // coloca modelo 1.5m à frente
      camDir.multiplyScalar(-1.5);
      const newPos = camPos.add(camDir);

      modelEntity.setAttribute('position', `${newPos.x} ${newPos.y} ${newPos.z}`);
      modelEntity.setAttribute('visible', 'true');

      showStatus("Modelo posicionado. Toque novamente para reposicionar.");
    });

    // Botão reset
    resetBtn.addEventListener('click', () => {
      modelEntity.setAttribute('visible', 'false');
      showStatus("Modelo resetado. Toque para posicionar novamente.");
    });
  </script>
</body>
</html>
